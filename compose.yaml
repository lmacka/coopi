version: "3"
services:
  coopi:
    image: lmacka/coopi:latest
    container_name: coopi
    privileged: true
    volumes:
      - coopi_var:/coopi/var/
    ports:
      - "8086:8086"
    restart: always
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: coopi nginx
    restart: unless-stopped
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
    depends_on:
      - coopi
    restart: always
    command: >
      sh -c "echo '
      events {}
      http {
          server {
              listen 80;
              location / {
                  proxy_pass http://coopi:8086;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_connect_timeout 180;
                  proxy_send_timeout 180;
                  proxy_read_timeout 180;
                  send_timeout 180;
              }
          }
      }' > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
volumes:
  coopi_var: